{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pulari Pipes | Premium PVC & Manufacturing</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3EPP%3C/text%3E%3C/svg%3E">

  <link rel="stylesheet" href="{% static 'css/intex_style.css'%}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

<nav>
  <div class="logo-area">
    <div class="logo-circle" aria-hidden="true">PP</div>
    <h2>PULARI PIPES</h2>
  </div>
  <ul>
    <li><a href="#home">Home</a></li>
    <li><a href="{% url 'product_page' %}">Products</a></li>
    <li><a onclick="toggleModal()"><i class="fa-solid fa-calculator"></i> Estimator</a></li>
    <li><a href="#about">About</a></li>
  </ul>
</nav>

<section id="home" class="expert-slider">
    <div class="slider-track">
        <div class="slide">
            <img src="/media/imgpul1.webp" alt="Pulari Pipes Manufacturing">
            <div class="slide-overlay">
                <div class="slide-content">
                    <h1>Building a Stronger <span>Future</span></h1>
                    <p>High-pressure PVC solutions designed for modern industrial growth.</p>
                    <button class="btn-main" onclick="toggleModal()">Estimate Needs</button>
                </div>
            </div>
        </div>
        <div class="slide">
            <img src="/media/imgpul.webp" alt="Agricultural Solutions">
            <div class="slide-overlay">
                <div class="slide-content">
                    <h1>ISI Grade <span>Durability</span></h1>
                    <p>Trusted by farmers for heavy-duty borewell and irrigation systems.</p>
                    <button class="btn-main" onclick="window.location.href='{% url 'product_page' %}'">View Products</button>
                </div>
            </div>
        </div>
        <div class="slide">
            <img src="/media/imgp1.webp" alt="Pulari Pipes">
            <div class="slide-overlay">
                <div class="slide-content">
                    <h1>Pure <span>Industrial Lime</span></h1>
                    <p>Supplying Micro-lime and Ultra-white solutions across India.</p>
                    <button class="btn-main" onclick="orderNow()">Enquire Now</button>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="stats-container reveal">
  <div class="stat-item">
      <h3 data-target="10">0</h3><p>Years Experience</p>
  </div>
  <div class="stat-item">
      <h3>3/4" - 10"</h3><p>Pipe Sizes</p>
  </div>
  <div class="stat-item">
      <h3>ISI</h3><p>Grade Standard</p>
  </div>
  <div class="stat-item">
      <h3 data-target="100">0</h3><p>% Virgin Material</p>
  </div>
</div>

<section id="products">
  <h2 class="section-title reveal">Specialized <span>Product Range</span></h2>
  
  <div class="product-grid">
    {% if items %}
      {% for product in items %}
        <div class="p-card reveal">
            {% if product.image %}
               <div style="height: 200px; width: 100%; overflow: hidden; border-radius: 12px; margin-bottom: 20px; background: #f1f5f9;">
                  <img src="{{ product.image.url }}" alt="{{ product.name }}" style="width: 100%; height: 100%; object-fit: cover;">
               </div>
            {% else %}
               <div style="height: 200px; width: 100%; display:flex; align-items:center; justify-content:center; background:#f1f5f9; border-radius:12px; margin-bottom:20px;">
                  <i class="fa-solid fa-box fa-3x" style="color:#cbd5e1;"></i>
               </div>
            {% endif %}

            <h3>{{ product.name }}</h3>
            <p style="font-size: 14px; color: #64748b;">{{ product.description|truncatewords:15 }}</p>
            
            <h4 style="color: var(--primary); font-size: 20px; margin: 10px 0;">‚Çπ{{ product.price }}</h4>

            <button class="buy-btn" onclick="selectAndScroll('{{ product.name }}')">Order Now</button>
        </div>
      {% endfor %}
    {% else %}
      <div style="text-align: center; width: 100%; grid-column: 1/-1;">
        <p style="font-size: 18px; color: #64748b;">Our catalog is being updated. Please check back soon!</p>
      </div>
    {% endif %}
  </div>
</section>

<section id="order-section" class="order-container">
  <div class="order-box reveal">
    <h2 class="form-title">Place Your Order</h2>
    
    <form id="pulariOrderForm" onsubmit="handleOrderSubmit(event)">
      <div class="form-group"><input type="text" id="custName" name="name" placeholder="Your Name" required></div>
      <div class="form-group"><input type="tel" id="custPhone" name="phone" placeholder="Phone Number" required></div>
      <div class="form-group"><input type="email" id="custEmail" name="email" placeholder="Email (optional)"></div>
      
      <div class="form-group">
        <select id="custProduct" name="product" required>
          <option value="" disabled selected>-- Select Product --</option>
          
          {% for product in items %}
              <option value="{{ product.name }}">{{ product.name }}</option>
          {% endfor %}
          
          <option value="Other / General Inquiry">Other / General Inquiry</option>
        </select>
      </div>

      <div class="form-group"><input type="number" id="custQty" name="quantity" placeholder="Quantity (e.g., 50 pipes)" min="1"></div>
      <div class="form-group"><textarea id="custMessage" name="message" placeholder="Message (optional)" rows="4"></textarea></div>
      <button type="submit" class="submit-btn">Submit Order</button>
    </form>
  </div>
</section>

<section id="about" style="padding-bottom: 0;">
    <div class="about-box reveal">
      <div class="gst-tag">GSTIN: 33AAYFP1489L1ZE</div>
      <h2 style="margin-top: 0; color: var(--text-head);">Pulari Pipes (Partnership Firm)</h2>
      <p style="color: var(--text-body); line-height: 1.8;">Located in <b>Cholapuram, Rajapalayam</b>, we are specialized manufacturers associated with <b>Sri A V T P Balaji Enterprises</b>. Trusted for high-grade PVC pipes and premium industrial lime manufacturing.</p>
      <p style="margin-top:20px; color: var(--primary); font-weight: 600;"><i class="fa-solid fa-location-dot"></i> 152C/4, Cholapuram - Melur Road, Virudhunagar DT, TN - 626139.</p>
    </div>
</section>

<footer>
  ¬© 2025 PULARI PIPES ‚Äî Cholapuram, Rajapalayam. <br>
  Sister Concerns: Sri Balaji Enterprises | Sri Padma Enterprises | Sri Balaji Firm
</footer>

<div class="modal-overlay" id="calcModal">
  <div class="modal-content">
    <span class="close-modal" onclick="toggleModal()">&times;</span>
    <h2 style="color: var(--primary); margin-top: 0;">üìè Pipe Estimator</h2>
    
    <div class="input-group" style="margin-bottom: 20px; text-align: left;">
      <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-head)">Project Area (Sq.ft)</label>
      <input type="number" id="areaIn" placeholder="e.g. 1500" oninput="calculate()" 
             style="width:100%; padding:14px; border-radius:10px; border:1px solid #cbd5e1; outline:none;">
    </div>
    
    <div class="input-group" style="margin-bottom: 20px; text-align: left;">
      <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-head)">Application</label>
      <select id="multiplier" onchange="calculate()" style="width:100%; padding:14px; border-radius:10px; border:1px solid #cbd5e1; outline:none;">
        <option value="0.8">Plumbing (Water & Waste)</option>
        <option value="1.5">Electrical Conduits</option>
        <option value="2.2">Heavy Industrial Piping</option>
      </select>
    </div>

    <div class="res-box">
      <p style="margin: 0; font-size: 13px; color: #64748b;">Estimation Details:</p>
      <h1 id="totalOut" style="margin: 5px 0; color: var(--primary); font-size: 28px;">0 Feet</h1>
      <h2 id="pipeCount" style="margin: 5px 0; color: var(--accent); font-size: 22px;">0 Pipes</h2>
    </div>
    <button class="btn-main" style="width: 100%; margin-top: 20px;" onclick="toggleModal()">Close Tool</button>
  </div>
</div>

<script>
  // --- 1. SCROLL REVEAL ANIMATION ---
  function reveal() {
    var reveals = document.querySelectorAll(".reveal");
    for (var i = 0; i < reveals.length; i++) {
      var windowHeight = window.innerHeight;
      var elementTop = reveals[i].getBoundingClientRect().top;
      var elementVisible = 150;
      if (elementTop < windowHeight - elementVisible) {
        reveals[i].classList.add("active");
      }
    }
  }
  window.addEventListener("scroll", reveal);
  reveal(); // Trigger on load

  // --- 2. NUMBER COUNTER ANIMATION ---
  const counters = document.querySelectorAll('.stat-item h3[data-target]');
  let hasAnimated = false; 

  function animateCounters() {
      const statsSection = document.querySelector('.stats-container');
      const position = statsSection.getBoundingClientRect().top;
      const screenPosition = window.innerHeight / 1.3;

      if(position < screenPosition && !hasAnimated) {
          counters.forEach(counter => {
              const target = +counter.getAttribute('data-target');
              const increment = target / 100;
              const updateCount = () => {
                  const c = +counter.innerText;
                  if(c < target) {
                      counter.innerText = Math.ceil(c + increment);
                      setTimeout(updateCount, 20);
                  } else {
                      counter.innerText = target + (target === 10 ? "+" : "%");
                  }
              };
              updateCount();
          });
          hasAnimated = true;
      }
  }
  window.addEventListener("scroll", animateCounters);

  // --- 3. MODAL LOGIC ---
  function toggleModal() {
    const modal = document.getElementById('calcModal');
    if (modal.style.display === "flex") {
      document.getElementById('areaIn').value = ""; 
      document.getElementById('totalOut').innerText = "0 Feet"; 
      document.getElementById('pipeCount').innerText = "0 Pipes"; 
      modal.style.display = "none";
    } else {
      modal.style.display = "flex";
    }
  }

  function calculate() {
    const area = document.getElementById('areaIn').value;
    const mult = document.getElementById('multiplier').value;
    if (area > 0) {
      let base = area * mult;
      let totalFeet = Math.ceil(base * 1.1); 
      let totalPipes = Math.ceil(totalFeet / 20);
      document.getElementById('totalOut').innerText = totalFeet + " Feet";
      document.getElementById('pipeCount').innerText = totalPipes + " Pipes (Approx)";
    } else {
      document.getElementById('totalOut').innerText = "0 Feet";
      document.getElementById('pipeCount').innerText = "0 Pipes";
    }
  }

  window.onclick = function(event) {
    if (event.target == document.getElementById('calcModal')) toggleModal();
  }

  // --- 4. SMART ORDER LOGIC ---
  
  // A. Scroll to form (General use)
  function orderNow() {
    document.getElementById('order-section').scrollIntoView({ behavior: 'smooth' });
  }

  // B. Select specific product and scroll (Used by buttons on this page)
  function selectAndScroll(productName) {
    const section = document.getElementById('order-section');
    section.scrollIntoView({ behavior: 'smooth' });
    
    // Select in dropdown
    const selectBox = document.getElementById('custProduct');
    selectBox.value = productName;
    
    // Fallback if value matching failed (e.g. slight spelling difference)
    if (selectBox.value !== productName) {
        // Try loop matching
         for (let i = 0; i < selectBox.options.length; i++) {
            if (selectBox.options[i].text === productName) {
                selectBox.selectedIndex = i;
                break;
            }
        }
    }
  }

  // C. Auto-Select from URL (Used when coming from Product Page)
  window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const productToSelect = urlParams.get('auto_select');

    if (productToSelect) {
        // Auto scroll to form
        document.getElementById('order-section').scrollIntoView({ behavior: 'smooth' });
        
        // Select in dropdown
        const selectBox = document.getElementById('custProduct');
        // Try direct assignment
        selectBox.value = productToSelect;

        // Verify assignment
        if (!selectBox.value) {
             for (let i = 0; i < selectBox.options.length; i++) {
                if (selectBox.options[i].text === productToSelect || selectBox.options[i].value === productToSelect) {
                    selectBox.selectedIndex = i;
                    break;
                }
            }
        }
    }
  };


  // --- 5. BACKEND HANDLER ---
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  async function handleOrderSubmit(e) {
    e.preventDefault();
    const orderData = {
      name: document.getElementById('custName').value,
      phone: document.getElementById('custPhone').value,
      email: document.getElementById('custEmail').value || "",
      product: document.getElementById('custProduct').value,
      quantity: document.getElementById('custQty').value || "",
      message: document.getElementById('custMessage').value || ""
    };

    try {
      const csrftoken = getCookie('csrftoken');
      const resp = await fetch('/orders/create/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(orderData)
      });

      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(text || 'Server error');
      }

      const data = await resp.json();
      alert('Order placed successfully! Order ID: ' + data.order_id);
      document.getElementById('pulariOrderForm').reset();
    } catch (err) {
      console.error('Order submit failed', err);
      alert('Unable to submit order. Please try again or call us directly.');
    }
  }
</script>

</body>
</html>